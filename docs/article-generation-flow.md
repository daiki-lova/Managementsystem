# 記事生成フロー設計書

> **Note**: このドキュメントは旧版です。最新の仕様は **[article-generation-orchestration-v1.md](./article-generation-orchestration-v1.md)** を参照してください。

## 概要

本ドキュメントは、CMSにおける記事生成の全体フローを定義する。
キーワード選定から記事完成までの流れ、各コンポーネントの役割を明確化する。

---

## 記事生成フロー全体像

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Phase 1: キーワード選定                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ユーザー入力              AIが分析                ユーザー選択      │
│  ┌─────────┐             ┌─────────┐            ┌─────────┐       │
│  │カテゴリ  │             │         │            │キーワード│       │
│  │コンバー │────────────▶│キーワード│───────────▶│候補から  │       │
│  │ジョン   │             │候補提案  │            │選択     │       │
│  │監修者   │             │(ボリューム│            │(最大5個)│       │
│  └─────────┘             │ 表示)    │            └─────────┘       │
│                          └─────────┘                  │            │
│                                                       ▼            │
│                                              気に入らない場合       │
│                                              「再分析」で再提案     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Phase 2: 記事生成パイプライン                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  選択したキーワードごとに6ステージパイプラインを実行                  │
│  （詳細は 6-stage-pipeline-plan.md 参照）                           │
│                                                                     │
│  Stage 1: キーワード分析・企画                                       │
│  Stage 2: 構成・安全設計                                             │
│  Stage 3: 記事執筆                                                   │
│  Stage 4: SEO/LLMO最適化                                            │
│  Stage 5: 監修・校正                                                 │
│  Stage 6: 保存・画像生成トリガー                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: キーワード選定ロジック

### ユーザーが入力する情報

| 入力項目 | DBテーブル | AIが参照するフィールド |
|---------|-----------|---------------------|
| カテゴリ | `categories` | `name`, `description` |
| コンバージョン | `conversions` | `name`, `type`, `context` |
| 監修者 | `authors` | `name`, `role`, `qualifications`, `bio`, `systemPrompt` |

### AIが総合的に分析する内容

```
┌──────────────────────────────────────────────────────────────┐
│                    AIのキーワード選定ロジック                   │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. カテゴリ                                                  │
│     └─ description から「テーマの範囲」を理解                 │
│                                                              │
│  2. コンバージョン                                            │
│     └─ context から「ターゲットユーザーの検索意図」を推測     │
│     └─ 「このコンバージョンに繋がりそうな検索クエリ」を探す   │
│                                                              │
│  3. 監修者                                                    │
│     └─ qualifications, bio から「専門性」を把握              │
│     └─ 紐づく情報バンク（knowledge_items）から                │
│        「書ける内容があるか」を判定                           │
│     └─ systemPrompt から「監修者の語り口・注意点」を理解      │
│                                                              │
│  4. 検索ボリューム範囲（system_settings）                     │
│     └─ minSearchVolume 〜 maxSearchVolume の範囲でフィルタ    │
│     └─ デフォルト: 300〜2,000                                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────┐
│                       キーワード候補提案                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  - カテゴリの範囲内で                                         │
│  - コンバージョンに繋がりそうな検索意図を持ち                 │
│  - 監修者の専門性・情報バンクで「書ける」内容があり           │
│  - 検索ボリュームが設定範囲内                                 │
│                                                              │
│  のキーワードを提案（ボリューム付き）                         │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### キーワード選定API

Keywords Everywhere APIを使用して検索ボリュームを取得。

```
POST /api/keywords/suggest

入力:
{
  categoryId: string,
  conversionId: string,
  authorId: string
}

出力:
{
  keywords: [
    {
      keyword: "ヨガ 初心者 始め方",
      volume: 980,
      competition: 0.45,
      score: 85,
      isRecommended: true,
      canWrite: true,  // 情報バンクに書ける内容があるか
      relatedKnowledgeItems: ["kb-001", "kb-003"]
    },
    ...
  ],
  recommendedRange: { min: 300, max: 2000 }
}
```

### バッチ処理

- ユーザーは最大5つのキーワードを選択可能
- 選択したキーワードごとに記事生成パイプラインを順次実行
- 時間がかかっても確実に5記事を生成

---

## Phase 2: 将来の拡張（既存記事分析）

記事が増えてきたら、以下のロジックを追加:

```
┌──────────────────────────────────────────────────────────────┐
│                 既存記事分析（Phase 2で実装予定）              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1. キーワードカニバリゼーション防止                          │
│     └─ 既存記事と同じ/類似キーワードを避ける                 │
│                                                              │
│  2. コンテンツギャップ分析                                    │
│     └─ まだカバーしていないキーワードを優先                  │
│                                                              │
│  3. 内部リンク戦略                                            │
│     └─ 既存の優良記事と繋げられるキーワードを提案            │
│                                                              │
│  4. パフォーマンス分析（GSC/GA4連携時）                       │
│     └─ 流入が多いがコンバージョンが弱い記事を補強            │
│     └─ 伸びしろのあるキーワードを発見                        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## データモデル関係図

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  categories │     │ conversions │     │   authors   │
│─────────────│     │─────────────│     │─────────────│
│ id          │     │ id          │     │ id          │
│ name        │     │ name        │     │ name        │
│ description │     │ type        │     │ role        │
│ slug        │     │ context  ◀──┼─────│ qualifications│
│             │     │ url         │     │ bio         │
│             │     │ status      │     │ systemPrompt│
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                           ▼
              ┌─────────────────────────┐
              │    キーワード選定AI      │
              │─────────────────────────│
              │ - 3つのコンテキストを    │
              │   総合的に分析          │
              │ - Keywords Everywhere   │
              │   APIでボリューム取得   │
              │ - 情報バンクで書ける    │
              │   かどうか判定          │
              └───────────┬─────────────┘
                          │
                          ▼
              ┌─────────────────────────┐
              │  knowledge_items        │
              │  (情報バンク)            │
              │─────────────────────────│
              │ - authorId で監修者と   │
              │   紐づき                │
              │ - categoryId で         │
              │   カテゴリと紐づき      │
              └─────────────────────────┘
```

---

## UI設計（フロントエンド）

### 記事生成画面のフロー

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: 基本設定                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  カテゴリ:     [▼ 初心者向けヨガ        ]                  │
│                                                             │
│  コンバージョン: [▼ 無料体験レッスン予約   ]                │
│                                                             │
│  監修者:       [▼ 山田花子（主宰インストラクター）]         │
│                                                             │
│                        [キーワードを探す]                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 2: キーワード選択                                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  AIが提案するキーワード候補（最大5つ選択可能）              │
│                                                             │
│  ☐ ヨガ 初心者 始め方        月間980回  ★推奨             │
│  ☐ 体が硬い ヨガ できる      月間720回  ★推奨             │
│  ☐ ヨガ 効果 いつから        月間650回  ★推奨             │
│  ☐ 自宅 ヨガ 初心者          月間540回                     │
│  ☐ ヨガ 始める 準備          月間320回                     │
│                                                             │
│         [再分析]                    [記事を生成]            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 3: 生成中...                                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  記事1: ヨガ 初心者 始め方                                  │
│  [████████████████░░░░░░░░] 65% - 記事を執筆中...          │
│                                                             │
│  記事2: 体が硬い ヨガ できる                                │
│  [░░░░░░░░░░░░░░░░░░░░░░░░] 待機中                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 更新履歴

| 日付 | 更新内容 |
|------|----------|
| 2024-12-13 | 初版作成: キーワード選定ロジック、全体フロー定義 |
