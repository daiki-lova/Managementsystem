# 記事生成オーケストレーション仕様書 v1

## ヨガ資格・ピラティス資格スクール向けメディア

---

## 1. 目的

本システムの目的は、スクール向けメディアにおいて「人の判断を起点に、AIで高品質な記事下書きを安定生成し、編集コストを最小化する」ことです。

**最重要コンバージョン**: オンライン説明会申込

v1では自動公開は行わず、生成物はすべて **下書き（DRAFT）** とします。

---

## 2. 対象範囲

### v1で提供するもの

「キーワード分析 → 人がキーワードを選択 → 記事HTML生成 → 画像3枚生成 → HTMLへ差し込み → 下書き保存」まで

### v1で提供しないもの

- 毎日自動生成
- 自動公開
- カテゴリと監修者の固定紐付け
- 注意（中カニバリ）をUIに出す機能

---

## 3. 用語定義（混同防止）

| 用語 | 定義 |
|------|------|
| 内部リンク | 関連記事へのリンク（記事→記事） |
| CTA・バナー・説明会申込ボタン | 内部リンクとは別物として扱う |

本仕様書内で「内部リンク」と書いた場合は、すべて**関連記事リンク**を意味します。

---

## 4. 管理画面フロー（ユーザー操作）

### 4.1 記事生成の起点（必須入力）

管理者は記事生成開始前に、以下を必ず選択します：

1. **カテゴリ**
2. **コンバージョン**（v1の第一目的はオンライン説明会申込）
3. **監修者**（1記事1名）
4. **キーワード分析を実行し、候補からメインキーワードを1つ選ぶ**

> この「人が最終キーワードを選ぶ」工程はv1では必須です（精度と安全を優先）

### 4.2 キーワード候補画面の表示ルール

| 判定結果 | UI表示 |
|---------|--------|
| OK | 表示する |
| 注意 | 非表示 |
| NG | 非表示 |

NG/注意の件数は任意で画面に出してもよいが、候補詳細は出しません。

---

## 5. キーワード分析（候補生成＋除外ロジック）

### 5.1 候補生成

AIは候補キーワードを列挙します。

- 「最終選定」「優先順位の確定」は行わない
- 候補に対して検索ボリューム等の外部データを付与

### 5.2 カニバリ判定（必須）

カニバリ判定は **ルール判定＋ベクトル類似** の併用で行います。

```
┌─────────────────────────────────────────────────────────────┐
│                    カニバリ判定フロー                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. ルール判定（事前フィルタ）                               │
│     └─ カテゴリ一致                                         │
│     └─ 主要語一致                                           │
│     └─ タグ一致                                             │
│     └─ → 候補記事集合を絞り込み                             │
│                                                             │
│  2. ベクトル類似（詳細判定）                                 │
│     └─ 記事の「骨格」を埋め込みに変換                       │
│        - タイトル                                           │
│        - H2一覧                                             │
│        - 導入200〜400字                                     │
│     └─ 類似度で判定                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**対象記事**: 公開済み（PUBLISHED）の記事のみ

### 5.3 NG/注意の扱い（裏側）

- NG/注意になった候補はUIに出さない
- 裏側にログとして保存（将来の既存記事改善に使うため）
- v1ではログを活用するUIは実装しない

---

## 6. 記事生成パイプライン（v1）

v1の生成は必ず以下の順序で実行します。途中で失敗しても「勝手に公開」は絶対に起きない状態を維持します。

### 6.1 入力（生成ジョブ作成時に確定）

```typescript
interface GenerationJobInput {
  categoryId: string;
  conversionId: string;        // オンライン説明会申込
  reviewerId: string;          // 1名固定
  chosenKeyword: string;       // 人が選んだメインKW
  seedKeywords?: string[];     // 任意
}
```

### 6.2 生成ステップ

```
┌─────────────────────────────────────────────────────────────────────┐
│                    記事生成パイプライン（8ステップ）                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Step 1: タイトル・アウトライン生成                                  │
│     │                                                               │
│     ▼                                                               │
│  Step 2: 一次情報抽出（情報バンクの確定データ化）                    │
│     │                                                               │
│     ▼                                                               │
│  Step 3: 外部根拠の探索（必要なテーマのみ）                          │
│     │                                                               │
│     ▼                                                               │
│  Step 4: 本文HTML生成                                                │
│     │                                                               │
│     ▼                                                               │
│  Step 5: 画像ジョブ生成                                              │
│     │                                                               │
│     ▼                                                               │
│  Step 6: 画像生成実行（Nanobanana）+ メディアライブラリ登録          │
│     │                                                               │
│     ▼                                                               │
│  Step 7: HTMLへ画像差し込み（置換）                                  │
│     │                                                               │
│     ▼                                                               │
│  Step 8: 下書き保存（DRAFT）                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### Step 1: タイトル・アウトライン生成（AI）

**目的**: 記事の骨格を固定し、後工程のブレを減らす

**処理内容**:
- タイトルはAIが最終案を確定し、そのまま採用（人は選ばない）
- 本文は生成しない

**出力（概念）**:
```typescript
interface Step1Output {
  title: string;                    // 採用タイトル
  metaTitleDraft: string;           // metaTitle案
  metaDescriptionDraft: string;     // metaDescription案
  outline: OutlineSection[];        // H2/H3アウトライン
  faqCandidates: FAQItem[];         // FAQ候補
  internalLinkSlots: number;        // 内部リンク挿入枠（自動算出）
  imageSlots: ImageSlot[];          // 画像スロット定義（固定3枠）
}

interface ImageSlot {
  slot: 'cover' | 'inbody_1' | 'inbody_2';
}
```

---

### Step 2: 一次情報抽出（情報バンクの確定データ化）

**目的**: 情報バンク（受講生の声・講師ブログ・スクール方針など）から、記事に使う根拠を「確定データ」として抽出

**処理方針**:
- 要約・言い換えを許可
- 出典（どの情報バンク由来か）は保持

**出力（概念）**:
```typescript
interface Step2Output {
  facts: Fact[];              // 事実・方針・特徴
  episodes: Episode[];        // 受講生の変化・体験談として使える要素
  constraints: Constraint[];  // 禁止表現・注意表現・断定禁止など
}

interface Fact {
  content: string;
  sourceId: string;           // knowledge_itemsのID
}
```

> 以降の本文生成は、このfacts/episodes/constraintsに反する内容を出さないことをシステムプロンプトで強制します。

---

### Step 3: 外部根拠（学術・公的資料）の探索

**実行条件**: 必要なテーマのみ（常時必須ではない）

**検索方針**: ホワイトリスト方式に限定

```
┌─────────────────────────────────────────────────────────────┐
│                  外部根拠検索フロー                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 検索実行: ツール側（MCP/検索API）                        │
│     └─ LLMではなく検索ツールで実行                          │
│                                                             │
│  2. 検証: URL/DOI/PMIDの実在確認                            │
│     └─ 検証に通らない文献は使わない                         │
│                                                             │
│  3. LLMへ渡す: 検証済みソースのみ                            │
│     └─ LLMは要約・引用のみ行う                              │
│                                                             │
│  4. 根拠なしの場合: 数値や効果の断定は出さない               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**出力（概念）**:
```typescript
interface Step3Output {
  verifiedSources: VerifiedSource[];
}

interface VerifiedSource {
  type: 'doi' | 'pmid' | 'url';
  identifier: string;
  title: string;
  summary: string;
  verifiedAt: string;
}
```

---

### Step 4: 本文HTML生成（AI）

**入力**:
- アウトライン（Step 1）
- 確定一次情報（Step 2）
- 検証済み外部根拠（Step 3、あれば）
- 監修者プロフィール
- コンバージョン

**出力**: HTML

**画像プレースホルダ（3スロット固定）**:
```html
<figure data-image-slot="cover"></figure>
...
<figure data-image-slot="inbody_1"></figure>
...
<figure data-image-slot="inbody_2"></figure>
```

**内部リンク**:
- 本文HTML内に `<a>` として挿入
- リンク先は公開済み記事のみ

---

### Step 5: 画像ジョブ生成（AI）

**入力**: 記事完成後の内容（要約）

**出力**: Nanobanana向けの画像生成ジョブ × 3件

```typescript
interface ImageJob {
  slot: 'cover' | 'inbody_1' | 'inbody_2';
  prompt: string;
  alt: string;
  width: number;
  height: number;
  avoid: string[];  // 禁止事項
}
```

> この時点では画像生成は実行しない

---

### Step 6: 画像生成実行（Nanobanana）＋ メディアライブラリ登録

**処理**:
1. Nanobanana APIで画像を生成
2. Supabase Storageへ保存
3. `media_assets` テーブルに登録

**失敗時の扱い**:
- 記事本文生成はロールバックしない（下書き優先）
- 通知・ログに残す
- 後で再生成できる状態にする

---

### Step 7: HTMLへ画像差し込み（置換）

プレースホルダを、生成した `media_assets` 参照の `<img>` に置換します。

**置換後のHTML例**:
```html
<figure data-image-slot="cover" data-asset-id="asset_123">
  <img src="https://.../asset_123.webp"
       alt="..."
       width="1200" height="630"
       fetchpriority="high">
</figure>
```

**ロード方針（固定）**:

| スロット | loading | fetchpriority |
|---------|---------|---------------|
| cover | なし | high |
| inbody_1 | lazy | - |
| inbody_2 | lazy | - |

**全画像共通**: `width/height` 必須、`alt` 必須

---

### Step 8: 下書き保存（DRAFT）

- 生成された記事は必ず下書き保存
- 勝手に公開しない
- 監修者情報は記事内に表示される形でHTMLまたはテンプレート領域に反映（E-E-A-T目的）

---

## 7. 監修者表示（E-E-A-T）

| 項目 | 仕様 |
|------|------|
| 人数 | 1記事1名（固定） |
| 表示位置 | 記事内に監修者ボックスを表示 |
| 表示内容 | プロフィールに存在する情報のみ |
| 禁止事項 | 資格・実績を推測で追加しない |

**プロフィール分離**:
- 公開用プロフィール
- 生成用プロフィール（システムプロンプト等）

---

## 8. 内部リンク（関連記事）仕様

### 8.1 挿入方式

- 本文HTML内に確定で挿入（レンダリング時に生成しない）
- SEO/LLMOの文脈情報として確実に見える状態にする

### 8.2 本数の決め方

```
┌─────────────────────────────────────────────────────────────┐
│                  内部リンク本数の決定ロジック                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  入力:                                                       │
│  - 記事の長さ                                                │
│  - H2数                                                      │
│  - 既存記事数                                                │
│                                                             │
│  出力:                                                       │
│  - 自動算出された本数（上下限あり）                          │
│                                                             │
│  ※ 固定値にしない                                           │
│  ※ 運用で調整可能にする                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**リンク先候補**: 公開済み記事のみ

### 8.3 クリック計測（v1から実装）

**方式**: 自前DB保存 ＋ GA4イベント送信（ブラウザ）併用

**HTMLの `<a>` に付与する識別子**:
```html
<a href="/articles/xxx"
   data-internal-link
   data-from="article_abc"
   data-to="article_xxx"
   data-slot="1"
   data-run-id="run_123">
  関連記事タイトル
</a>
```

| 属性 | 説明 |
|------|------|
| data-from | リンク元記事ID |
| data-to | リンク先記事ID |
| data-slot | 記事内での連番（1, 2, 3...） |
| data-run-id | 生成ジョブID |

**クリック時の処理**:
1. `sendBeacon` で自前APIへ送信
2. GA4へ `internal_link_click` イベント送信
3. 送信失敗しても遷移は止めない

**将来の最適化（v2以降）**:
- クリック率・説明会到達・申込への寄与を加味
- v1では「内容の近さ（ベクトル）」中心で動作

---

## 9. 外部根拠（文献・公的資料）ルール

### 担保構造

| 役割 | 担当 |
|------|------|
| 検索と検証 | ツール側（MCP/検索API） |
| 要約・言い換え | LLM（検証済みソースの範囲内のみ） |

### ルール

1. 検証できないソースは入力に渡さない（＝引用できない）
2. 根拠が無い場合は数値・効果は書かない
3. 実在確認必須（DOI/PMID/URL）
4. 推測禁止
5. 統計は原文引用

---

## 10. 失敗時の扱い（v1）

| 失敗箇所 | 扱い |
|---------|------|
| 生成途中で失敗 | 記事は公開されない。失敗情報はジョブログに残す |
| 画像生成失敗 | 記事は下書きで残す。画像スロットは空でもよい（後で再生成可能） |
| 文献取得失敗 | その記事では文献根拠を使わずに生成。数値断定は避ける |

---

## 11. v2以降の拡張余地（設計だけ確保）

- [ ] 自動キーワード選定（条件付き）
- [ ] 自動生成スケジュール（毎日n本）
- [ ] 自動公開（低リスクのみ）
- [ ] 既存記事改善（NGカニバリログの活用）
- [ ] 内部リンク選定の学習（クリック率・説明会申込寄与）

---

## 12. 最終確認チェックリスト

v1実装前の意思決定確認：

| # | 項目 | 確認 |
|---|------|------|
| 1 | スクール向けに特化し、最重要CVはオンライン説明会申込 | ✅ |
| 2 | v1は手動起点、記事はDRAFT、勝手に公開しない | ✅ |
| 3 | キーワード候補はOKのみ表示（注意/NGは非表示、裏で保存） | ✅ |
| 4 | HTML生成、画像は記事完成後に3枚生成して差し込み、差し替え可能（Supabase Storage） | ✅ |
| 5 | 内部リンクは本文内に挿入、候補は公開済み記事のみ、クリック計測はDB＋GA4 | ✅ |
| 6 | 文献は必要なテーマのみ、ホワイトリスト検索＋検証済みだけを引用 | ✅ |

---

## 更新履歴

| 日付 | 更新内容 |
|------|----------|
| 2024-12-15 | v1仕様書作成（6ステージパイプラインから8ステップパイプラインへ刷新） |
